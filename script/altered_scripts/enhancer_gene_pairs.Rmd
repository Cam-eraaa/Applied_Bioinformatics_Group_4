---
title: "Trying to connect gene and enhancer"
author: "Elin Antonsson"
output: html_document

params:
  workingDir: ~/Applied_Bioinformatics_Group_4/
  PROseq.gene.data: results/original_method/PROseq/PROseq.data.tsv
  enhancer.data: results/altered_method/from_joint_peak/enhancers.tsv
  #enhancer.data: results/altered_method/from_joint_peak/enhancers_no_filtering.tsv
  #enhancer.data: results/altered_method/from_joint_peak/UMAP_enhancers.tsv
  resultsDir: results/altered_method/pairs/
  resultsFile: EGP_PCA_filtering.tsv
  #resultsFile: EGP_no_filtering.tsv
  #resultsFile: EGP_UMAP.tsv
  
  resultsDirAnno: results/altered_method/pairs/
  functionAnnotation: hgTables.txt
  resultsAnnotated15kb: annotated_results15kb_PCA_filtering.tsv
  #resultsAnnotated15kb: annotated_results15kb_no_filtering.tsv
  #resultsAnnotated15kb: annotated_results15kb_UMAP.tsv
  resultsAnnotatedCleaned15kb: annotated_cleaned_results15kb_PCA_filtering.tsv
  #resultsAnnotatedCleaned15kb: annotated_cleaned_results15kb_no_filtering.tsv
  #resultsAnnotatedCleaned15kb: annotated_cleaned_results15kb_UMAP.tsv

  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(GenomicRanges)
library(clusterProfiler)
library(org.Dm.eg.db)
```


```{r from ATAC-CBP_seq_analysis}

#This is just the output from PROseq_analysis
our_enhancer_file = paste(params$workingDir, params$enhancer.data, sep = "")

our_enhancer_data = read.table(
  file = our_enhancer_file ,
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)

our_enhancer_data = tibble::rowid_to_column(our_enhancer_data, "enhancer_row")

our_enhancer_data= our_enhancer_data %>% dplyr::rename(
  "Enhancer_ID" = geneID, 
  "Enhancer_Start" = ATAC_Start, 
  "Enhancer_End" = ATAC_End)

#This is the output from joint_peak
ourEnhancerData = makeGRangesFromDataFrame(our_enhancer_data,
                                      seqnames.field = "Chr", 
                                      start.field = "start", 
                                      end.field = "end")

PROseq_gene_file = paste(params$workingDir, params$PROseq.gene.data, sep = "")

PROseq.gene.data = read.table(
  file = PROseq_gene_file ,
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)

PROseqGeneInfo = PROseq.gene.data %>%  dplyr::select(geneID, Chr, Start, End, Strand, direction, factor) %>% dplyr::rename(
  "Gene_geneID" = geneID,
  "Gene_Chr" = Chr,
  "Gene_Start" = Start,
  "Gene_End" = End,
  "Gene_Strand" = Strand,
  "Gene_Direction" = direction,
  "Gene_Factor" = factor
)

PROseqGeneInfo = PROseqGeneInfo %>% distinct()

PROseqGeneInfo$Gene_Chr = paste("chr",PROseqGeneInfo$Gene_Chr, sep = "")
PROseqGeneInfo = tibble::rowid_to_column(PROseqGeneInfo, "gene_row")

PROData = makeGRangesFromDataFrame(PROseqGeneInfo,
                                      seqnames.field = "Gene_Chr", 
                                      start.field = "Gene_Start", 
                                      end.field = "Gene_End")

test_pairs = data.frame(distanceToNearest(ourEnhancerData, PROData, ignore.strand=TRUE))
colnames(test_pairs) = c("enhancer_row","gene_row","EnhancerDistance")

joined = inner_join(PROseqGeneInfo, test_pairs)
joined = inner_join(our_enhancer_data, joined)

joined$PRO_direction = gsub(pattern = "None", replacement = "Up", joined$Gene_Direction)
joined$PROseq_Classification = paste(joined$Gene_Factor,joined$PRO_direction, sep = " " )
joined$ATACseq_Classification = paste(joined$ATAC_factor,joined$ATAC_direction, sep = " " )

enhancer_gene_pairs = joined %>% dplyr::select(Enhancer_ID, Chr, Enhancer_Start, Enhancer_End, Gene_geneID, Gene_Chr, Gene_Start, Gene_End, EnhancerDistance, PROseq_Classification, ATACseq_Classification)

enhancer_gene_pairs_unique = unique(enhancer_gene_pairs)

```

```{r Filtering}
enhancer_gene_pairs_unique_ambiguous = enhancer_gene_pairs_unique %>% filter(EnhancerDistance >= 0 & EnhancerDistance < 1500 )  
enhancer_gene_pairs_unique_over_15kb = enhancer_gene_pairs_unique %>% filter(EnhancerDistance > 1500)  
```


```{r save the data}
write.table(
  x = enhancer_gene_pairs_unique_over_15kb,
  file = paste(params$workingDir, params$resultsDir, params$resultsFile, sep = ""),
  quote = F,
  sep = "\t",
  row.names = F,
  col.names = T
)

```

## Add annotation for the genes
```{r from annotation.Rmd}
# Load the ATAC seq loading scores
annotation_data = read.table(
  file = paste(params$workingDir, params$functionAnnotation, sep = ""),
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)
pairs = enhancer_gene_pairs_unique_over_15kb
annotation_data_cleaned = annotation_data %>% dplyr::select(acc, protFullNames, score, geneName, functionText)
annotation_data_cleaned = annotation_data_cleaned %>% dplyr::rename(name = acc,
                                                                    geneFunc = protFullNames,
                                                                    geneFuncFullText = functionText)

# Needs a name to match the annotation files
pairs_cleaned = pairs %>% dplyr::select(Enhancer_ID, Gene_geneID)
universe <- bitr(
  unique(pairs_cleaned$Gene_geneID),
  fromType = "ENSEMBL",
  toType = c("UNIPROT"),
  OrgDb = org.Dm.eg.db
)
universe  =  universe %>% dplyr::rename(Gene_geneID = ENSEMBL, name = UNIPROT)

# Join the uniprot names with the Ensembl IDs
pairs_uniprotID = inner_join(pairs, universe, by = "Gene_geneID")
# Now join the pairs with the annotation from SwissProtUniprot
AllData = inner_join(pairs_uniprotID, annotation_data_cleaned, by = "name")

# Make the results cleaner for output. One file with less information for easier overview
AllData_renamed = AllData %>% dplyr::rename(
  UNIPROTname = name,
  Enhancer_Chr = Chr,
  Enhancer_Start = Enhancer_Start,
  Enhancer_End = Enhancer_End
)
AllData_cleaned = AllData_renamed %>% dplyr::select(
  Enhancer_ID,
  Gene_geneID,
  EnhancerDistance,
  PROseq_Classification,
  ATACseq_Classification,
  UNIPROTname,
  geneFunc,
  geneName,
  geneFuncFullText
)
# The more complete result file
results = paste(params$workingDir,
                params$resultsDirAnno,
                params$resultsAnnotated15kb ,
                sep = "")
write.table(
  x = AllData,
  file = results,
  quote = F,
  sep = "\t",
  row.names = F,
  col.names = T
)
# The result file with better overview
results_cleaned = paste(params$workingDir,
                               params$resultsDirAnno,
                               params$resultsAnnotatedCleaned15kb ,
                               sep = "")
write.table(
  x = AllData_cleaned,
  file = results_cleaned,
  quote = F,
  sep = "\t",
  row.names = F,
  col.names = T
)

```


