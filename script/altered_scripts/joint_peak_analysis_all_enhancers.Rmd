---
title: "Identifying the enhancer gene pairs"
author: "Elin Antonsson"
date: "12/03/2020"
output: html_document

params:
  workingDir: ~/Applied_Bioinformatics_Group_4/
  RscriptsDir: script/original_scripts/
  inSitu.data: data_johan/results/cleaned/inSitu/inSitu.Stark.dm6.tsv
  PROseq.data: results/altered_method/PROseq/PROseq.CBP.data.tsv
  PROseq.gene.data: results/original_method/PROseq/PROseq.data.tsv
  ChIPseqDir: results/original_method/ChIPseq/
  CBP.data: CBP/ChIPseq.CBP.data.tsv
  K27ac.data: K27ac/ChIPseq.H3K27Ac.data.tsv
  ATACseq.data: results/original_method/ATACseq/ATACseq.data.tsv
  GD7enhancer: data_johan/results/cleaned/enhancers/h3k27ac_gd7_csaw_intersect.bed
  Toll10Benhancer: data_johan/results/cleaned/enhancers/h3k27ac_Toll10B_csaw_intersect.bed
  Toll9enhancer: data_johan/results/cleaned/enhancers/h3k27ac_Tollrm910_csaw_intersect.bed
  enhancerResult: results/altered_method/enhancers/enhancers.tsv
  Regions: results/altered_method/enhancers/regions_id.tsv
  results_file: results/altered_method/all.combined.AllData.withMetaData.txt
  results_file_cleaned: results/altered_method/all.AllData_cleaned.txt
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(paste(params$workingDir, params$RscriptsDir,"ExpressionAnalysisFunctions.r", sep = ""))

#install.packages("tidyverse")
#install.packages("ROCit")
#install.packages("patchwork")
#BiocManager::install("heatmaps")
library("heatmaps")
library(patchwork)
library(ROCit)
library(tidyverse)
library(GenomicRanges)

```
# Combining the scores to predict enhancer gene pairs

## Load the required files
```{r Loading the ATACseq data files}
# Load the ATAC seq loading scores
ATACseq.data = read.table(
  file = paste(params$workingDir, params$ATACseq.data, sep = ""),
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)
# Rename the columns
ATACseqInfo = ATACseq.data %>% dplyr::rename(
  "ATAC_Gd7" = Gd7,
  "ATAC_Toll10b" = Toll10b,
  "ATAC_Toll9" = Toll9,
  "ATAC_Time" = Time,
  "ATAC_Start" = Start,
  "ATAC_End" = End ,
  "ATAC_factor" = factor,
  "ATAC_direction" = direction, 
  
)

```

```{r laoding the ChIPseq data files}
#Load the ChIPseq data for CBP
CBPInfo =  read.table(
  file = paste(params$workingDir, params$ChIPseqDir, params$CBP.data, sep = ""), 
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)
# Rename the mutant headers
CBPInfo = CBPInfo %>%
  dplyr::select(geneID, Gd7, Toll10b, Toll9) %>%
  dplyr::rename("CBP_Gd7" = Gd7,
                "CBP_Toll10b" = Toll10b,
                "CBP_Toll9" = Toll9)

# Load the ChIPseq data for H3K27ac
K27acInfo =  read.table(
  file = paste(params$workingDir,params$ChIPseqDir, params$K27ac.data, sep = "/"),
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)
# Rename the columns
K27acInfo = K27acInfo %>% dplyr::rename(
  "K27ac_geneID" = geneID,
  "K27ac_Start" = Start,
  "K27ac_End" = End ,
  "K27ac_factor" = factor,
  "K27ac_direction" = direction,
  "K27ac_Gd7" = Gd7,
  "K27ac_Toll10b" = Toll10b,
  "K27ac_Toll9" = Toll9,
  "K27ac_Chr" = Chr,
  "K27ac_Strand" = Strand,
  "K27ac_Length" = Length
)
```

```{r Load the PROseq data files}
# Load the PROseq data
PROseq_file = paste(params$workingDir, params$PROseq.data, sep = "")

PROseq.data = read.table(
  file = PROseq_file ,
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)

# Rename headers.
PROseqInfo = PROseq.data %>%  dplyr::select(geneID, Gd7, Toll10b, Toll9, Time, factor, direction) %>% dplyr::rename(
  "PRO_Gd7" = Gd7,
  "PRO_Toll10b" = Toll10b,
  "PRO_Toll9" = Toll9,
  "PRO_Time" = Time, 
  "Factor" = factor, 
  "Direction" = direction
)

# Here is where I added the file from PROseq_analysis in original_method. I want to overlap with the CBP peaks by using e.g. enhancer distance 15kb
PROseq_gene_file = paste(params$workingDir, params$PROseq.gene.data, sep = "")

PROseq.gene.data = read.table(
  file = PROseq_gene_file ,
  quote = "",
  sep = "\t",
  header = TRUE,
  stringsAsFactors = F
)


PROseqGeneInfo = PROseq.gene.data %>%  dplyr::select(geneID, Chr, Start, End, Strand) %>% dplyr::rename(
  "Gene_geneID" = geneID,
  "Gene_Chr" = Chr,
  "Gene_Start" = Start,
  "Gene_End" = End,
  "Gene_Strand" = Strand
)

```


```{r convert into genomic ranges}
# Convert dataframe to a genomic range
K27ac_peakData = makeGRangesFromDataFrame(
  K27acInfo,
  seqnames.field = "K27ac_Chr",
  start.field = "K27ac_Start",
  end.field = "K27ac_End",
  strand.field = "K27ac_Strand",
)
names(K27ac_peakData) = K27acInfo$K27ac_geneID
PRO_genes_peakData = makeGRangesFromDataFrame(PROseqGeneInfo,
                                              seqnames.field = "Gene_Chr",
                                              start.field = "Gene_Start",
                                              end.field = "Gene_End",
                                              strand.field = "Gene_Strand"
                                              )
names(PRO_genes_peakData) = PROseqGeneInfo$geneID

# Kanske kan anvÃ¤nda detta till att joina PROoch ATAC seq???
#test = data.frame(distanceToNearest(ATAC_peakData,PRO_genes_peakData,  ignore.strand=TRUE))


ATAC_peakData = makeGRangesFromDataFrame(ATACseqInfo,
                                      seqnames.field = "Chr", 
                                      start.field = "ATAC_Start", 
                                      end.field = "ATAC_End", 
                                      strand.field = "Strand")
names(ATAC_peakData) = ATACseqInfo$geneID


```

```{r join the data}
CBPpeak.ATAC.PRO  = inner_join(ATACseqInfo, PROseqInfo, by = "geneID")
CBPpeak.ATAC.PRO.CBP  = inner_join(CBPpeak.ATAC.PRO, CBPInfo, by = "geneID")

```


```{r find the overlap and adding annotation}
# Parameter???
overlap_ATAC_K27ac = data.frame(findOverlaps(ATAC_peakData,K27ac_peakData, maxgap = 0))
overlap_ATAC_K27ac$K27ac_geneID = names(K27ac_peakData)[overlap_ATAC_K27ac$subjectHits]
overlap_ATAC_K27ac$geneID = names(ATAC_peakData)[overlap_ATAC_K27ac$queryHits]
overlap_ATAC_K27ac = overlap_ATAC_K27ac %>% dplyr::select(K27ac_geneID,geneID )

CBPpeak.ATAC.PRO.CBP  = inner_join(CBPpeak.ATAC.PRO.CBP,  overlap_ATAC_K27ac)
CBPpeak.ATAC.PRO.CBP.K27ac =  inner_join(CBPpeak.ATAC.PRO.CBP,  K27acInfo, by="K27ac_geneID")

CBPpeak.ATAC.PRO.CBP.K27ac$geneID_unique = make.names(CBPpeak.ATAC.PRO.CBP.K27ac$geneID, unique = TRUE)



```



```{r PCA analysis, include=FALSE}

allEnhancerInfo2 = CBPpeak.ATAC.PRO.CBP.K27ac %>% dplyr::select(-geneID,-K27ac_geneID, -Chr, -Strand, -Length, -ATAC_direction, -ATAC_factor, -ATAC_Start, -ATAC_End, -K27ac_Strand, -K27ac_Start, -K27ac_End, -K27ac_Length, -K27ac_direction, -K27ac_factor, -K27ac_Chr, -geneID_unique)

rownames(allEnhancerInfo2) = CBPpeak.ATAC.PRO.CBP.K27ac$geneID_unique
allEnhancerInfo2 = as.numeric(as.factor(allEnhancerInfo2))

mir.pca <- prcomp(allEnhancerInfo2, center = TRUE, scale = FALSE) 
e.var = (mir.pca[['sdev']]^2 / sum(mir.pca[['sdev']]^2))
e.var = as.data.frame( e.var )
e.var$PC = as.factor(1:nrow(e.var)) 
e.var$Variance = e.var$e.var*100
e.var$CumulativeVariance = cumsum(e.var$Variance)
qplot(PC, Variance, data=e.var, geom = c("point")
      , ylim = c(0,max(e.var$Variance)+5) 
      ,ylab = "Variance (%)")

pctable = as.data.frame(mir.pca$x)[, 1:5]

pctable$geneID_unique = rownames(pctable)

AllData = left_join(EnhancerInfo,pctable)

AllData = AllData %>% mutate(distance5 = (PC1^2+PC2^2+PC3^2+PC4^2++PC5^2)^0.5)
AllData = AllData %>% mutate(distance4 = (PC1^2+PC2^2+PC3^2+PC4^2)^0.5)
AllData = AllData %>% mutate(distance3 = (PC1^2+PC2^2+PC3^2)^0.5)
AllData = AllData %>% mutate(distance2 = (PC1^2+PC2^2)^0.5)
AllData = AllData %>% mutate(distance1 = abs(PC1))

FE =  AllData %>% filter(enhancer == 1) %>% ggplot(aes(PC1, PC2, color = enhancerGenotype )) + geom_point()+ geom_density_2d(AllData,mapping = aes(PC1, PC2), color= "grey")
FI =  AllData %>% filter(inSitu == 1) %>% ggplot(aes(PC1, PC2, color = inSituLocation )) + geom_point()+ geom_density_2d(AllData,mapping = aes(PC1, PC2), color= "grey")
```

```{r plot this steps }

PE+PI+ plot_layout(ncol = 1)
AE+AI+ plot_layout(ncol = 1)
CE+CI+ plot_layout(ncol = 1)
KE+KI+ plot_layout(ncol = 1)
FE + FI+ plot_layout(ncol = 1)

PE+PI+AE+AI+CE+CI+KE+KI+FE+FI +plot_layout(ncol = 2)


```


### Assesment and selection

```{r roc analysis  , include=FALSE}
enhancerData = AllData

d1ROCi = getROCinfo(AllData,scoreColumn = "distance1", classColumn = "inSitu")
d2ROCi = getROCinfo(AllData,scoreColumn = "distance2", classColumn = "inSitu")
d3ROCi = getROCinfo(AllData,scoreColumn = "distance3", classColumn = "inSitu")
d4ROCi = getROCinfo(AllData,scoreColumn = "distance4", classColumn = "inSitu")
d5ROCi = getROCinfo(AllData,scoreColumn = "distance5", classColumn = "inSitu")
d1ROCe = getROCinfo(AllData,scoreColumn = "distance1", classColumn = "enhancer")
d2ROCe = getROCinfo(AllData,scoreColumn = "distance2", classColumn = "enhancer")
d3ROCe = getROCinfo(AllData,scoreColumn = "distance3", classColumn = "enhancer")
d4ROCe = getROCinfo(AllData,scoreColumn = "distance4", classColumn = "enhancer")
d5ROCe = getROCinfo(AllData,scoreColumn = "distance5", classColumn = "enhancer")



ROCplotInfo = rbind (d1ROCi$ROCplotInfo, d2ROCi$ROCplotInfo, d3ROCi$ROCplotInfo,d4ROCi$ROCplotInfo, d5ROCi$ROCplotInfo,
                     d1ROCe$ROCplotInfo, d2ROCe$ROCplotInfo, d3ROCe$ROCplotInfo,d4ROCe$ROCplotInfo, d5ROCe$ROCplotInfo)
ROCplotSummary = rbind(d1ROCi$Youden, d2ROCi$Youden, d3ROCi$Youden,d4ROCi$Youden, d5ROCi$Youden,
                     d1ROCe$Youden, d2ROCe$Youden, d3ROCe$Youden,d4ROCe$Youden, d5ROCe$Youden)


```

```{r plot ROC}

ROCplotSummary

qplot(PC, Variance, data=e.var, geom = c("point")
      , ylim = c(0,max(e.var$Variance)+5)
      ,ylab = "Variance (%)")


ggplot(ROCplotInfo, mapping =  aes(x = FPR, y = TPR, color = score))+
  geom_line()+
  geom_abline()+
  geom_point(data = ROCplotSummary, mapping = aes(y = TPR, x = FPR, color = score ), size = 4) +
    facet_grid(.~classifier)

```
# Enhancer selection


Based on ROC statistics  it is best if we include all five PC  

```{r plot classification }
scores = ROCplotSummary %>% dplyr::filter(classifier == "enhancer" & score == "distance5")

AllData.enhancers = AllData %>% filter(distance5 > scores$YoudenCutoff)

AllData.enhancers = AllData.enhancers %>% replace_na(list(enhancerID = "None", enhancerGenotype = "None",insituID = "None",inSituLocation = "None", inSituScore = -1 ))


peakInfo = data.frame(ATAC_peakData)
peakInfo$geneID = names(ATAC_peakData)

AllData.enhancers = AllData.enhancers %>% dplyr::select(-geneID_unique)
AllData.enhancers = inner_join(peakInfo, AllData.enhancers, by = "geneID")
AllData.enhancers_cleaned = AllData.enhancers %>% dplyr::select(geneID, -seqnames, Chr, start, end, -width, -strand, -ATAC_Start, -ATAC_End, -Strand, Length, ATAC_factor, ATAC_direction, ATAC_Gd7,  ATAC_Toll10b, ATAC_Toll9, ATAC_Time, PRO_Gd7, PRO_Toll10b, PRO_Toll9, PRO_Time, CBP_Gd7,  CBP_Toll10b, CBP_Toll9, K27ac_geneID, -K27ac_Chr, -K27ac_Start, -K27ac_End, -K27ac_Strand, -K27ac_Length,  -K27ac_factor, -K27ac_direction, K27ac_Gd7, K27ac_Toll10b, K27ac_Toll9, enhancerID, enhancerGenotype, insituID, inSituLocation, inSituScore, enhancer, inSitu, PC1, PC2, PC3, PC4, PC5, distance1, distance2, distance3, distance4, distance5)

fileName = paste(params$workingDir, params$enhancerResult, sep = "")

#write.table(x = AllData.enhancers_cleaned, file = fileName, sep = "\t", quote = F, row.names = F, col.names = T )


```


## Taken from combining_all_data

```{r merge all the data }
AllData_test = CBPpeak.ATAC.PRO.CBP.K27ac %>% mutate(Enhancer_Gd7 =  ATAC_Gd7 + CBP_Gd7 + K27ac_Gd7)
AllData_test = AllData_test %>% mutate(Enhancer_Toll10b =  ATAC_Toll10b + CBP_Toll10b + K27ac_Toll10b)
AllData_test = AllData_test %>% mutate(Enhancer_Toll9 =  ATAC_Toll9 + CBP_Toll9 + K27ac_Toll9)

PRO_ATAC_CHiP_data = AllData_test %>%
  group_by(ATAC_factor, ATAC_direction) %>%
  summarise(
    PRO_Time = mean(PRO_Time),
    PRO_Gd7 = mean(PRO_Gd7),
    PRO_Toll10b = mean(PRO_Toll10b),
    PRO_Toll9 = mean(PRO_Toll9),
    ATAC_Time = mean(ATAC_Time),
    ATAC_Gd7 = mean(ATAC_Gd7),
    ATAC_Toll10b = mean(ATAC_Toll10b),
    ATAC_Toll9 = mean(ATAC_Toll9),
    K27ac_Gd7 = mean(K27ac_Gd7),
    K27ac_Toll10b = mean(K27ac_Toll10b),
    K27ac_Toll9 = mean(K27ac_Toll9),
    CBP_Gd7 = mean(CBP_Gd7),
    CBP_Toll10b = mean(CBP_Toll10b),
    CBP_Toll9 = mean(CBP_Toll9)
  )

AllData = AllData_test %>% dplyr::select(
  PRO_Time,
  PRO_Gd7,
  PRO_Toll10b,
  PRO_Toll9,
  ATAC_Time,
  ATAC_Gd7,
  ATAC_Toll10b,
  ATAC_Toll9,
  CBP_Gd7,
  CBP_Toll10b,
  CBP_Toll9,
  K27ac_Gd7,
  K27ac_Toll10b,
  K27ac_Toll9
)

AllData.saved = AllData_test

```

```{r save the data}
write.table(
  x = AllData,
  file = paste(params$workingDir, params$results_file , sep = "/"),
  quote = F,
  sep = "\t",
  row.names = F,
  col.names = T
)

cleaned_AllData = AllData %>% dplyr::select(geneID, ATACseq_geneID, factor, direction)

write.table(
  x = cleaned_AllData,
  file = paste(params$workingDir, params$results_file_cleaned , sep = "/"),
  quote = F,
  sep = "\t",
  row.names = F,
  col.names = T
)

```







